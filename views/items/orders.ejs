<% layout('../layout/boilerplate') -%>

<%
function getOrderCategory(createdAt) {
    const orderDate = new Date(createdAt);
    const today = new Date();
    const diffInTime = today - orderDate;
    const diffInDays = Math.floor(diffInTime / (1000 * 60 * 60 * 24));
    
    if (diffInDays === 0) {
        return "Today's Orders";
    } else if (diffInDays === 1) {
        return "Yesterday's Orders";
    } else {
        return `${diffInDays} Days Ago`;
    }
}

const groupedOrders = {};

for (let order of allOrder) {
    const category = getOrderCategory(order.createdAt);
    if (!groupedOrders[category]) {
        groupedOrders[category] = [];
    }
    groupedOrders[category].push(order);
}
%>

<% for (let category in groupedOrders) { %>
    <h2><%= category %></h2>
    <% for (let order of groupedOrders[category]) { %>
        <hr>
        <% let user = order.author %>

        <li class="list-group-item">Order placed at : <%= new Date(order.createdAt).toLocaleString("en-IN", { timeZone: "Asia/Kolkata", hour: "2-digit", minute: "2-digit" }); %>
        </li>
        <ul class="list-group list-group-horizontal justify-content-between" >
            <li class="list-group-item"><%= user.name %></li>
            <li class="list-group-item"><%= user.mobile %></li>
            <li class="list-group-item">
                <% if (user.coordinates) { %>
                    <a href="https://www.google.com/maps?q=<%= user.coordinates[1] %>,<%= user.coordinates[0] %>">
                        <button type="button" class="btn btn-success">
                            <i class="fa-solid fa-location-dot"></i>
                        </button>
                    </a>
                    <% } else { %>
                        <% console.log(user.coordinates) %>
                    <span class="text-danger">Location not available</span>
                <% } %>
                
              </li>              
              <li class="list-group-item">
                <form method="POST" action="/order/<%=order._id%>/delete?_method=DELETE">
                    <button class="btn btn-danger"><i class="fa-solid fa-trash"></i></button>
                </form>
            </li>            
        </ul>
        
        <table class="table table-primary">
            <thead class="thead-primary">
                <tr>
                    <th>Item</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Rate</th>
                </tr>
            </thead>
            <tbody>
                <% let sum = 0; %>
                <% for (let orderItem of order.items) { %>
                    <tr>
                        <td><%= orderItem.item.title %></td>
                        <td><%= orderItem.item.typ %></td>
                        <td><%= orderItem.item.price.toLocaleString("en-In") %> &#8377;/<%= orderItem.item.unit %></td>
                        <td>
                            <%= orderItem.item.quantity.toLocaleString("en-In") %> <%= orderItem.item.unit %>
                        </td>
                        <td><%= (orderItem.item.quantity * orderItem.item.price).toLocaleString("en-In") %></td>
                    </tr>
                    <% sum += orderItem.item.quantity * orderItem.item.price %>
                <% } %>
                <tr>
                    <td><b>Transport Charge</b></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><b><%= ((user.distance * 2).toFixed(2)).toLocaleString("en-In") %> &#8377;</b></td>
                </tr>
                <tr>
                    <td><b>Balance Due</b></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><b><%= user.balance_due.toLocaleString("en-In") %> &#8377;</b></td>
                </tr>
                <tr>
                    <td><b>Total</b></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><b><%= (Math.floor(sum + user.balance_due + (user.distance * 2))).toLocaleString("en-In") %> &#8377;</b></td>
                </tr>
            </tbody>
        </table>
        
        <div class="d-grid gap-2 col-12 mx-auto">
            <form method="POST" action="/owner/<%= order._id %>/status">
                <div class="form-floating mb-1 ">
                    <select class="form-select" id="floatingSelect_<%= order._id %>" name="orderStatus" aria-label="Floating label select example">
                      <option selected><%= order.status %></option>
                      <option value="1">Order Processing</option>
                      <option value="2">Shipped</option>
                      <option value="3">Out for Delivery</option>
                      <option value="4">Delivered</option>
                    </select>
                    <label for="floatingSelect">Order Status</label>
                  </div>
                <button type="submit" class="btn btn-success" id="updateStatusBtn_<%= order._id %>">Update Status</button>
            </form>
            <div class="d-grid gap-2 col-12 mx-auto">
                <form method="get" action="/owner/<%= order._id %>/quantity">
                    <button type="submit" class="btn btn-primary">Update Quantity</button>
                </form>
            </div>
        </div>
        <br>
    <% } %>
<% } %>

<script>
   document.addEventListener('DOMContentLoaded', function () {
    var selectBoxes = document.querySelectorAll(".form-select");
    var updateButtons = document.querySelectorAll(".btn-success");

    selectBoxes.forEach(function(selectBox) {
        selectBox.addEventListener('change', function () {
            toggleUpdateButton(selectBox);
        });
    });

    function toggleUpdateButton(selectBox) {
        var orderId = selectBox.id.split("_")[1];
        var updateButton = document.getElementById("updateStatusBtn_" + orderId);

        if (selectBox.value === "1" || selectBox.value === "2" || selectBox.value === "3" || selectBox.value === "4") {
            updateButton.disabled = false;
        } else {
            updateButton.disabled = true;
        }
    }

    selectBoxes.forEach(function(selectBox) {
        toggleUpdateButton(selectBox);
    });
});
</script>
